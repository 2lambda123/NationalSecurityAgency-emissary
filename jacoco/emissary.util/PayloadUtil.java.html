<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PayloadUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Emissary</a> &gt; <a href="index.source.html" class="el_package">emissary.util</a> &gt; <span class="el_source">PayloadUtil.java</span></div><h1>PayloadUtil.java</h1><pre class="source lang-java linenums">package emissary.util;

import emissary.config.ConfigUtil;
import emissary.config.Configurator;
import emissary.core.Family;
import emissary.core.IBaseDataObject;
import emissary.core.TransformHistory;
import emissary.util.xml.JDOMUtil;

import org.jdom2.Document;
import org.jdom2.Element;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.time.Instant;
import java.util.Collection;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.regex.Pattern;

/**
 * Utilities for dealing with IBaseDataObject and Lists thereof
 */
public class PayloadUtil {
<span class="fc" id="L28">    public static final Logger logger = LoggerFactory.getLogger(PayloadUtil.class);</span>

<span class="fc" id="L30">    private static final String LS = System.getProperty(&quot;line.separator&quot;);</span>
<span class="fc" id="L31">    private static final Pattern validFormRegex = Pattern.compile(&quot;^[\\w-)(/+]+$&quot;);</span>

<span class="fc" id="L33">    protected static final Map&lt;String, String&gt; historyPreference = new HashMap&lt;&gt;();</span>

    protected static final String REDUCED_HISTORY = &quot;REDUCED_HISTORY&quot;;
    protected static final String NO_URL = &quot;NO_URL&quot;;

    @SuppressWarnings(&quot;NonFinalStaticField&quot;)
    protected static boolean compactHistory;

    static {
<span class="fc" id="L42">        configure();</span>
<span class="fc" id="L43">    }</span>

    protected static void configure() {
<span class="fc" id="L46">        Configurator configG = null;</span>
        try {
<span class="fc" id="L48">            configG = ConfigUtil.getConfigInfo(PayloadUtil.class);</span>
<span class="fc" id="L49">            compactHistory = configG.findBooleanEntry(&quot;COMPACT_HISTORY&quot;, false);</span>
<span class="nc" id="L50">        } catch (IOException e) {</span>
<span class="nc" id="L51">            logger.error(&quot;Cannot open default config file&quot;, e);</span>
<span class="fc" id="L52">        }</span>

        // fill lists with data from PayloadUtil.cfg for transform itinerary/history
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">        if (configG != null) {</span>
<span class="pc bpc" id="L56" title="1 of 2 branches missed.">            for (String fileType : configG.findEntries(REDUCED_HISTORY)) {</span>
<span class="nc" id="L57">                setFileTypeHistoryPreference(fileType, REDUCED_HISTORY);</span>
<span class="nc" id="L58">            }</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">            for (String fileType : configG.findEntries(NO_URL)) {</span>
<span class="nc" id="L60">                setFileTypeHistoryPreference(fileType, NO_URL);</span>
<span class="nc" id="L61">            }</span>
        }
<span class="fc" id="L63">    }</span>

    /**
     * Check if fileType is already mapped to history preference. If not, set fileType -$gt; preference in map
     *
     * @param fileType current fileType pulled from cfg
     * @param preference preference associated with current cfg fileType
     */
    protected static void setFileTypeHistoryPreference(String fileType, String preference) {
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (historyPreference.containsKey(fileType)) {</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">            if (historyPreference.get(fileType).equals(preference)) {</span>
                // log if filetype is assigned in the same preference more than once
<span class="nc" id="L75">                logger.warn(&quot;FileType {} is assigned to {} in cfg more than once.&quot;, fileType, preference);</span>
            } else {
                // log if filetype already has previous preference assignment
<span class="nc" id="L78">                logger.warn(&quot;FileType {} already has history preference {} assigned. {} will be ignored.&quot;, fileType,</span>
<span class="nc" id="L79">                        historyPreference.get(fileType), preference);</span>
            }
        } else {
<span class="nc" id="L82">            historyPreference.put(fileType, preference);</span>
        }
<span class="nc" id="L84">    }</span>

    /**
     * Try really hard to get a meaningful name for a payload object
     */
    public static String getName(final Object o) {
<span class="fc" id="L90">        String payloadName = o.getClass().getName();</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">        if (o instanceof IBaseDataObject) {</span>
<span class="fc" id="L92">            payloadName = ((IBaseDataObject) o).shortName();</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">        } else if (o instanceof Collection) {</span>
<span class="fc" id="L94">            final Iterator&lt;?&gt; pi = ((Collection&lt;?&gt;) o).iterator();</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">            if (pi.hasNext()) {</span>
<span class="fc" id="L96">                payloadName = ((IBaseDataObject) pi.next()).shortName() + &quot;(&quot; + ((Collection&lt;?&gt;) o).size() + &quot;)&quot;;</span>
            }
        }
<span class="fc" id="L99">        return payloadName;</span>
    }

    /**
     * Generate a string about the payload object
     * 
     * @param payload the payload to describe
     * @param oneLine true for a condensed one-line string
     */
    public static String getPayloadDisplayString(final IBaseDataObject payload, final boolean oneLine) {
<span class="fc bfc" id="L109" title="All 2 branches covered.">        return oneLine ? getPayloadOneLineString(payload) : getPayloadDisplayString(payload);</span>
    }

    /**
     * Generate a string about the payload object
     * 
     * @param payload the payload to describe
     */
    public static String getPayloadDisplayString(final IBaseDataObject payload) {
<span class="fc" id="L118">        final StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L119">        final TransformHistory th = payload.getTransformHistory();</span>
<span class="fc" id="L120">        final String fileName = payload.getFilename();</span>
<span class="fc" id="L121">        final String fileType = payload.getFileType();</span>
<span class="fc" id="L122">        final List&lt;String&gt; currentForms = payload.getAllCurrentForms();</span>
<span class="fc" id="L123">        final Instant creationTimestamp = payload.getCreationTimestamp();</span>

<span class="fc" id="L125">        sb.append(&quot;\n&quot;).append(&quot;filename: &quot;).append(fileName).append(&quot;\n&quot;).append(&quot;   creationTimestamp: &quot;).append(creationTimestamp).append(&quot;\n&quot;)</span>
<span class="fc" id="L126">                .append(&quot;   currentForms: &quot;).append(currentForms).append(&quot;\n&quot;).append(&quot;   filetype: &quot;).append(fileType).append(&quot;\n&quot;)</span>
<span class="fc" id="L127">                .append(&quot;   transform history (&quot;).append(th.size(true)).append(&quot;) :&quot;).append(&quot;\n&quot;);</span>

        // transform history output
<span class="fc" id="L130">        String historyCase = configureHistoryCase(fileType);</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">        if (historyCase.equals(REDUCED_HISTORY)) {</span>
            // found reduced history match, output only dropoff
<span class="fc" id="L133">            sb.append(&quot;   ** reduced transform history **&quot;).append(&quot;\n&quot;).append(&quot;     dropOff -&gt; &quot;)</span>
<span class="fc" id="L134">                    .append(payload.getLastPlaceVisited())</span>
<span class="fc" id="L135">                    .append(&quot;\n&quot;);</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">        } else if (compactHistory) {</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">            for (String history : th.format()) {</span>
<span class="fc" id="L138">                sb.append(&quot;     &quot;).append(history).append(&quot;\n&quot;);</span>
<span class="fc" id="L139">            }</span>
        } else {
<span class="fc bfc" id="L141" title="All 2 branches covered.">            for (final TransformHistory.History h : th.getHistory()) {</span>
<span class="fc" id="L142">                sb.append(&quot;     &quot;).append(h.getKey(historyCase.equals(NO_URL))).append(&quot;\n&quot;);</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">                for (final String coord : h.getCoordinated(historyCase.equals(NO_URL))) {</span>
<span class="nc" id="L144">                    sb.append(&quot;      &quot;).append(coord).append(&quot;\n&quot;);</span>
<span class="nc" id="L145">                }</span>
<span class="fc" id="L146">            }</span>
        }

<span class="fc" id="L149">        return sb.toString();</span>
    }

    /**
     * Check if fileType in PayloadUtil.cfg matches current payload fileType
     *
     * @param fileType current payload fileType
     * @return string for output case
     */
    public static String configureHistoryCase(String fileType) {
<span class="fc bfc" id="L159" title="All 2 branches covered.">        if (historyPreference.containsKey(fileType)) {</span>
<span class="fc" id="L160">            return historyPreference.get(fileType);</span>
        }
        // no match for current fileType, return empty string
<span class="fc" id="L163">        return &quot;&quot;;</span>
    }

    /**
     * Generate a one-line string about the payload object
     * 
     * @param payload the payload to describe
     */
    public static String getPayloadOneLineString(final IBaseDataObject payload) {
<span class="fc" id="L172">        final StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L173">        final String fn = payload.getFilename();</span>
<span class="fc" id="L174">        final int attPos = fn.indexOf(Family.SEP);</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">        if (attPos != -1) {</span>
<span class="fc" id="L176">            sb.append(fn.substring(attPos + 1)).append(&quot; &quot;);</span>
        }
<span class="fc" id="L178">        final List&lt;String&gt; th = payload.transformHistory(true);</span>
<span class="fc" id="L179">        String prev = &quot;&quot;;</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">        for (final String h : th) {</span>
<span class="fc" id="L181">            final int pos = h.indexOf(&quot;.&quot;);</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">            if (pos &gt; 0) {</span>
<span class="fc" id="L183">                final String prefix = h.substring(0, pos);</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">                if (!prev.equals(prefix)) {</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">                    if (prev.length() != 0) {</span>
<span class="fc" id="L186">                        sb.append(&quot;,&quot;);</span>
                    }
<span class="fc" id="L188">                    sb.append(prefix);</span>
<span class="fc" id="L189">                    prev = prefix;</span>
                }
            }
<span class="fc" id="L192">        }</span>
<span class="fc" id="L193">        sb.append(&quot;&gt;&gt;&quot;).append(payload.getAllCurrentForms());</span>
<span class="fc" id="L194">        sb.append(&quot;//&quot;).append(payload.getFileType());</span>
<span class="fc" id="L195">        sb.append(&quot;//&quot;).append(payload.getCreationTimestamp());</span>
<span class="fc" id="L196">        return sb.toString();</span>
    }

    /**
     * Turn the payload into an xml jdom document
     * 
     * @param d the payload
     */
    public static Document toXml(final IBaseDataObject d) {
<span class="fc" id="L205">        final Element root = new Element(&quot;payload&quot;);</span>
<span class="fc" id="L206">        root.addContent(JDOMUtil.protectedElement(&quot;name&quot;, d.getFilename()));</span>
<span class="fc" id="L207">        final Element cf = new Element(&quot;current-forms&quot;);</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">        for (final String c : d.getAllCurrentForms()) {</span>
<span class="fc" id="L209">            cf.addContent(JDOMUtil.simpleElement(&quot;current-form&quot;, c));</span>
<span class="fc" id="L210">        }</span>
<span class="fc" id="L211">        root.addContent(cf);</span>
<span class="fc" id="L212">        root.addContent(JDOMUtil.simpleElement(&quot;encoding&quot;, d.getFontEncoding()));</span>
<span class="fc" id="L213">        root.addContent(JDOMUtil.simpleElement(&quot;filetype&quot;, d.getFileType()));</span>
<span class="fc" id="L214">        root.addContent(JDOMUtil.simpleElement(&quot;classification&quot;, d.getClassification()));</span>
<span class="fc" id="L215">        final Element th = new Element(&quot;transform-history&quot;);</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">        for (final String s : d.transformHistory(true)) {</span>
<span class="fc" id="L217">            th.addContent(JDOMUtil.simpleElement(&quot;itinerary-step&quot;, s));</span>
<span class="fc" id="L218">        }</span>
<span class="fc" id="L219">        root.addContent(th);</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">        if (d.getProcessingError() != null) {</span>
<span class="fc" id="L221">            root.addContent(JDOMUtil.simpleElement(&quot;processing-error&quot;, d.getProcessingError()));</span>
        }
<span class="fc" id="L223">        final Element meta = new Element(&quot;metadata&quot;);</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">        for (final String key : d.getParameters().keySet()) {</span>
<span class="fc" id="L225">            final Element m = JDOMUtil.protectedElement(&quot;param&quot;, d.getStringParameter(key));</span>
<span class="fc" id="L226">            m.setAttribute(&quot;name&quot;, key);</span>
<span class="fc" id="L227">            meta.addContent(m);</span>
<span class="fc" id="L228">        }</span>
<span class="fc" id="L229">        root.addContent(meta);</span>

<span class="fc bfc" id="L231" title="All 2 branches covered.">        if (d.header() != null) {</span>
<span class="fc" id="L232">            root.addContent(JDOMUtil.protectedElement(&quot;header&quot;, d.header()));</span>
        }
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">        if (d.dataLength() &gt; 0) {</span>
<span class="fc" id="L235">            root.addContent(JDOMUtil.protectedElement(&quot;data&quot;, d.data()));</span>
        }
<span class="fc bfc" id="L237" title="All 2 branches covered.">        if (d.footer() != null) {</span>
<span class="fc" id="L238">            root.addContent(JDOMUtil.protectedElement(&quot;footer&quot;, d.footer()));</span>
        }

        // Alt views
<span class="fc bfc" id="L242" title="All 2 branches covered.">        if (d.getNumAlternateViews() &gt; 0) {</span>
<span class="fc" id="L243">            final Element views = new Element(&quot;views&quot;);</span>
<span class="fc bfc" id="L244" title="All 2 branches covered.">            for (final String av : d.getAlternateViewNames()) {</span>
<span class="fc" id="L245">                final Element v = JDOMUtil.protectedElement(&quot;view&quot;, d.getAlternateView(av));</span>
<span class="fc" id="L246">                v.setAttribute(&quot;name&quot;, av);</span>
<span class="fc" id="L247">                views.addContent(v);</span>
<span class="fc" id="L248">            }</span>
<span class="fc" id="L249">            root.addContent(views);</span>
        }

<span class="fc" id="L252">        logger.debug(&quot;Produced xml document for {}&quot;, d.shortName());</span>
<span class="fc" id="L253">        return new Document(root);</span>
    }

    /**
     * Turn a list of payload into an xml jdom ocument
     * 
     * @param list the payload list
     */
    public static Document toXml(final List&lt;IBaseDataObject&gt; list) {
<span class="fc" id="L262">        final Element root = new Element(&quot;payload-list&quot;);</span>
<span class="fc bfc" id="L263" title="All 2 branches covered.">        for (final IBaseDataObject d : list) {</span>
<span class="fc" id="L264">            final Document doc = toXml(d);</span>
<span class="fc" id="L265">            root.addContent(doc.detachRootElement());</span>
<span class="fc" id="L266">            logger.debug(&quot;Adding xml content for {} to document&quot;, d.shortName());</span>
<span class="fc" id="L267">        }</span>
<span class="fc" id="L268">        return new Document(root);</span>
    }

    /**
     * Turn the payload into an xml string
     * 
     * @param d the payload
     */
    public static String toXmlString(final IBaseDataObject d) {
<span class="fc" id="L277">        return JDOMUtil.toString(toXml(d));</span>
    }

    /**
     * Turn the payload list into an xml string
     * 
     * @param list the payload list
     */
    public static String toXmlString(final List&lt;IBaseDataObject&gt; list) {
<span class="fc" id="L286">        return JDOMUtil.toString(toXml(list));</span>
    }

    /**
     * Print formatted metadata key:value pairs
     */
    private static final String SEP = &quot;: &quot;;

    public static String printFormattedMetadata(final IBaseDataObject payload) {
<span class="fc" id="L295">        final StringBuilder out = new StringBuilder();</span>
<span class="fc" id="L296">        out.append(LS);</span>
<span class="fc bfc" id="L297" title="All 2 branches covered.">        for (final Map.Entry&lt;String, Collection&lt;Object&gt;&gt; entry : payload.getParameters().entrySet()) {</span>
<span class="fc" id="L298">            out.append(entry.getKey()).append(SEP).append(entry.getValue()).append(LS);</span>
<span class="fc" id="L299">        }</span>
<span class="fc" id="L300">        return out.toString();</span>
    }

    /**
     * Checks whether the form complies with form rules established by a regex
     *
     * Approved forms can contain alpha-numerics, '-', '_', '()', '/', '+'
     *
     * @param form The form to be tested
     * @return Whether the form is Emissary compliant
     */
    public static boolean isValidForm(String form) {
<span class="fc" id="L312">        return validFormRegex.matcher(form).find();</span>
    }

    /** This class is not meant to be instantiated. */
    private PayloadUtil() {}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>