<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PeersCommand.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Emissary</a> &gt; <a href="index.source.html" class="el_package">emissary.command</a> &gt; <span class="el_source">PeersCommand.java</span></div><h1>PeersCommand.java</h1><pre class="source lang-java linenums">package emissary.command;

import emissary.config.ConfigUtil;
import emissary.config.Configurator;
import emissary.directory.KeyManipulator;

import com.google.common.net.HostAndPort;
import picocli.CommandLine;
import picocli.CommandLine.Command;
import picocli.CommandLine.Option;

import java.io.IOException;
import java.util.Set;
import java.util.TreeSet;

@Command(description = &quot;Read the peers.cfg (respective flavors) and return hosts as bashable list&quot;, subcommands = {HelpCommand.class})
<span class="fc" id="L17">public class PeersCommand extends HttpCommand {</span>

    public static final String COMMAND_NAME = &quot;peers&quot;;

    private static final String PEER_CONFIG = &quot;peer.cfg&quot;;

<span class="fc" id="L23">    @Option(names = {&quot;-d&quot;, &quot;--delimiter&quot;},</span>
            description = &quot;delimiter to use when writing host output (note: newline needs to be \\n\nDefault: ${DEFAULT-VALUE}&quot;)
    private String delimiter = &quot;,&quot;;

<span class="fc" id="L27">    @Option(names = {&quot;-ih&quot;, &quot;--ignoreHost&quot;}, description = &quot;the host to ignore with optional port (host[:port])\nDefault: &lt;empty string&gt;&quot;)</span>
    private String ignoreHost = &quot;&quot;;

<span class="fc" id="L30">    @Option(names = &quot;--withPort&quot;, description = &quot;returns each peer with associated port\nDefault: ${DEFAULT-VALUE}&quot;)</span>
    private boolean withPort = false;

    @Override
    public String getCommandName() {
<span class="fc" id="L35">        return COMMAND_NAME;</span>
    }

    @Override
    @SuppressWarnings(&quot;SystemOut&quot;)
    public void run(CommandLine c) {
<span class="nc" id="L41">        setup();</span>
        try {
<span class="nc" id="L43">            System.out.print(String.join(delimiter, getPeers(HostAndPort.fromString(ignoreHost), this.withPort)));</span>
<span class="nc" id="L44">        } catch (IOException e) {</span>
<span class="nc" id="L45">            LOG.debug(&quot;Problem reading file&quot;, e);</span>
<span class="nc" id="L46">        }</span>
<span class="nc" id="L47">    }</span>

    @Override
    public void setup() {
<span class="nc" id="L51">        super.setup();</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">        if (delimiter.contains(&quot;\\n&quot;)) {</span>
<span class="nc" id="L53">            String replaced = delimiter.replaceAll(&quot;\\\\n&quot;, System.getProperty(&quot;line.separator&quot;));</span>
<span class="nc" id="L54">            delimiter = replaced;</span>
        }

<span class="nc" id="L57">    }</span>

    public static Set&lt;String&gt; getPeers(final HostAndPort ignoreHost, boolean wantPort) throws IOException {
<span class="nc" id="L60">        Configurator peerConfig = ConfigUtil.getConfigInfo(PEER_CONFIG);</span>
<span class="nc" id="L61">        final Set&lt;String&gt; peers = peerConfig.findEntriesAsSet(&quot;RENDEZVOUS_PEER&quot;);</span>
<span class="nc" id="L62">        final Set&lt;String&gt; added = new TreeSet&lt;&gt;();</span>
<span class="nc" id="L63">        peers.forEach(peerString -&gt; {</span>
            // form peer config files
<span class="nc" id="L65">            HostAndPort peer = HostAndPort.fromString(KeyManipulator.getServiceHost(peerString));</span>

<span class="nc bnc" id="L67" title="All 6 branches missed.">            if ((ignoreHost.hasPort() &amp;&amp; !ignoreHost.equals(peer)) || !ignoreHost.getHost().equals(peer.getHost())) {</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">                if (wantPort) {</span>
<span class="nc" id="L69">                    added.add(peer.toString());</span>
                } else {
<span class="nc" id="L71">                    added.add(peer.getHost());</span>
                }
            }
<span class="nc" id="L74">        });</span>

<span class="nc" id="L76">        return added;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>