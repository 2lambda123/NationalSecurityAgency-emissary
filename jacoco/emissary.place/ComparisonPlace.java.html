<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ComparisonPlace.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Emissary</a> &gt; <a href="index.source.html" class="el_package">emissary.place</a> &gt; <span class="el_source">ComparisonPlace.java</span></div><h1>ComparisonPlace.java</h1><pre class="source lang-java linenums">package emissary.place;

import emissary.core.DiffCheckConfiguration;
import emissary.core.IBaseDataObject;
import emissary.core.IBaseDataObjectHelper;
import emissary.core.ResourceException;
import emissary.util.PlaceComparisonHelper;

import org.apache.commons.lang3.Validate;

import java.io.IOException;
import java.lang.reflect.Constructor;
import java.util.Collections;
import java.util.List;

/**
 * This place takes two other places, gives each place a copy of the received IBDO and compares the output of the two
 * places.
 * &lt;p&gt;
 * NOTE: The configurations for the two places to be compared are used to construct the places internally; however, the
 * two places are never registered with the Emissary framework. Therefore, it is only the configuration for this class
 * that is registered with the Emissary framework. This means that PLACE_NAME, SERVICE_NAME, SERVICE_PROXY, etc. must
 * all be set correctly (and is most likely based on the two places being compared's configurations) in this place's
 * configuration in order to execute the two places to be compared correctly.
 * &lt;p&gt;
 * NOTE: the ibdo and attachments returned by Place A are the ones returned from this class.
 * &lt;p&gt;
 * The configuration file for this class must contain the five properties defined by the five constants in this class.
 */
public class ComparisonPlace extends ServiceProviderPlace {
    /**
     * The full pathname for the first class.
     */
    public static final String PLACE_A_CLASSNAME = &quot;PLACE_A_CLASSNAME&quot;;
    /**
     * The full pathname for the configuration for the first class.
     */
    public static final String PLACE_A_CONFIGNAME = &quot;PLACE_A_CONFIGNAME&quot;;
    /**
     * The full pathname for the second class.
     */
    public static final String PLACE_B_CLASSNAME = &quot;PLACE_B_CLASSNAME&quot;;
    /**
     * The full pathname for the configuration for the second class.
     */
    public static final String PLACE_B_CONFIGNAME = &quot;PLACE_B_CONFIGNAME&quot;;
    /**
     * An identifier to be added to the log message.
     */
    public static final String LOGGING_IDENTIFIER = &quot;LOGGING_IDENTIFIER&quot;;

    private static final String CONFIG_ERROR_MSG = &quot; must be defined in the configuration file!&quot;;
    private static final String PROCESS_PROCESSHD_MSG = &quot;Mixed process/processHeavyDuty not allowed!&quot;;

    private final ServiceProviderPlace placeA;
    private final ServiceProviderPlace placeB;
    private final String loggingIdentifier;

    public ComparisonPlace(final String configFile, final String theDir, final String thePlaceLocation) throws IOException {
<span class="fc" id="L60">        super(configFile, theDir, thePlaceLocation);</span>

<span class="fc" id="L62">        final String placeAClassName = configG.findStringEntry(PLACE_A_CLASSNAME);</span>
<span class="fc" id="L63">        final String placeAConfigName = configG.findStringEntry(PLACE_A_CONFIGNAME);</span>
<span class="fc" id="L64">        final String placeBClassName = configG.findStringEntry(PLACE_B_CLASSNAME);</span>
<span class="fc" id="L65">        final String placeBConfigName = configG.findStringEntry(PLACE_B_CONFIGNAME);</span>

<span class="fc" id="L67">        loggingIdentifier = configG.findStringEntry(LOGGING_IDENTIFIER);</span>

<span class="fc" id="L69">        Validate.notNull(placeAClassName, PLACE_A_CLASSNAME + CONFIG_ERROR_MSG);</span>
<span class="fc" id="L70">        Validate.notNull(placeAConfigName, PLACE_A_CONFIGNAME + CONFIG_ERROR_MSG);</span>
<span class="fc" id="L71">        Validate.notNull(placeBClassName, PLACE_B_CLASSNAME + CONFIG_ERROR_MSG);</span>
<span class="fc" id="L72">        Validate.notNull(placeBConfigName, PLACE_B_CONFIGNAME + CONFIG_ERROR_MSG);</span>
<span class="fc" id="L73">        Validate.notNull(loggingIdentifier, LOGGING_IDENTIFIER + CONFIG_ERROR_MSG);</span>

<span class="fc" id="L75">        placeA = createPlace(placeAClassName, placeAConfigName);</span>
<span class="fc" id="L76">        placeB = createPlace(placeBClassName, placeBConfigName);</span>

<span class="fc" id="L78">        placeA.shutDown();</span>
<span class="fc" id="L79">        placeB.shutDown();</span>

<span class="fc bfc" id="L81" title="All 2 branches covered.">        Validate.isTrue(placeA.processMethodImplemented == placeB.processMethodImplemented, PROCESS_PROCESSHD_MSG);</span>
<span class="fc" id="L82">    }</span>

    @Override
    public List&lt;IBaseDataObject&gt; processHeavyDuty(final IBaseDataObject ibdoA) throws ResourceException {
<span class="fc" id="L86">        final IBaseDataObject ibdoB = IBaseDataObjectHelper.clone(ibdoA, true);</span>
        final List&lt;IBaseDataObject&gt; attachmentsA;
        final List&lt;IBaseDataObject&gt; attachmentsB;

<span class="fc bfc" id="L90" title="All 2 branches covered.">        if (placeA.processMethodImplemented) {</span>
<span class="fc" id="L91">            placeA.process(ibdoA);</span>
<span class="fc" id="L92">            placeB.process(ibdoB);</span>

<span class="fc" id="L94">            attachmentsA = Collections.emptyList();</span>
<span class="fc" id="L95">            attachmentsB = Collections.emptyList();</span>
        } else {
<span class="fc" id="L97">            attachmentsA = placeA.processHeavyDuty(ibdoA);</span>
<span class="fc" id="L98">            attachmentsB = placeB.processHeavyDuty(ibdoB);</span>
        }

<span class="fc" id="L101">        final String differences = checkDifferences(ibdoA, ibdoB, attachmentsA, attachmentsB, loggingIdentifier);</span>

<span class="fc bfc" id="L103" title="All 2 branches covered.">        if (differences != null) {</span>
<span class="fc" id="L104">            logDifferences(differences);</span>
        }

<span class="fc" id="L107">        return attachmentsA;</span>
    }

    /**
     * This method checks for the differences in the output between the two places and can be overridden for custom
     * behaviour.
     * 
     * @param ibdoA the IBDO from the first place.
     * @param ibdoB the IBDO from the second place.
     * @param attachmentsA the list of attachments from the first place.
     * @param attachmentsB the list of attachments from the second place.
     * @param loggingIdentifier the identifier to be added to the message to be logged.
     * @return the differences to be logger or null if there are no differences.
     */
    protected String checkDifferences(final IBaseDataObject ibdoA, final IBaseDataObject ibdoB, final List&lt;IBaseDataObject&gt; attachmentsA,
            final List&lt;IBaseDataObject&gt; attachmentsB, final String loggingIdentifier) {
<span class="fc" id="L123">        return PlaceComparisonHelper.checkDifferences(ibdoB, ibdoA, attachmentsB, attachmentsA, loggingIdentifier,</span>
<span class="fc" id="L124">                DiffCheckConfiguration.onlyCheckData());</span>
    }

    /**
     * This method logs the differences in the output between the two places and can be overriden for custom behaviour.
     * 
     * @param differences to be logged.
     */
    protected void logDifferences(final String differences) {
<span class="fc" id="L133">        logger.info(differences);</span>
<span class="fc" id="L134">    }</span>

    /**
     * This method creates a place given a class name and configuration file.
     * 
     * @param className of the place.
     * @param configName of the place.
     * @return the place
     * @throws IOException if anything goes wrong.
     */
    public static final ServiceProviderPlace createPlace(final String className, final String configName) throws IOException {
        try {
<span class="fc" id="L146">            final Class&lt;?&gt; placeAClass = Class.forName(className);</span>
<span class="fc" id="L147">            final Constructor&lt;?&gt; placeAConstructor = placeAClass.getConstructor(String.class, String.class, String.class);</span>

<span class="fc" id="L149">            return (ServiceProviderPlace) placeAConstructor.newInstance(null, null, configName);</span>
<span class="fc" id="L150">        } catch (Exception e) {</span>
<span class="fc" id="L151">            throw new IOException(&quot;Unable to create &quot; + className, e);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>