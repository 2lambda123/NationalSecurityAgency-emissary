<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Configs.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Emissary</a> &gt; <a href="index.source.html" class="el_package">emissary.server.api</a> &gt; <span class="el_source">Configs.java</span></div><h1>Configs.java</h1><pre class="source lang-java linenums">package emissary.server.api;

import emissary.client.response.Config;
import emissary.client.response.ConfigList;
import emissary.client.response.ConfigsResponseEntity;
import emissary.config.ConfigEntry;
import emissary.config.ConfigUtil;
import emissary.config.Configurator;
import emissary.config.ServiceConfigGuide;

import com.google.common.collect.Lists;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.PathParam;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.Response;
import org.apache.commons.lang3.StringUtils;

import java.io.IOException;
import java.util.Arrays;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
import java.util.stream.Collectors;

import static emissary.config.ConfigUtil.CONFIG_FILE_ENDING;
import static emissary.core.constants.Configurations.RESERVED_SERVICE_CONFIG_KEYS;

@Path(&quot;&quot;)
// context is /api
<span class="nc" id="L32">public class Configs {</span>

    @GET
    @Path(&quot;/configuration/{name}&quot;)
    @Produces(MediaType.APPLICATION_JSON)
    public Response config(@PathParam(&quot;name&quot;) String name) {
<span class="nc" id="L38">        return getConfigs(name, false);</span>
    }

    @GET
    @Path(&quot;/configuration/detailed/{name}&quot;)
    @Produces(MediaType.APPLICATION_JSON)
    public Response configDetail(@PathParam(&quot;name&quot;) String name) {
<span class="nc" id="L45">        return getConfigs(name, true);</span>
    }

    /**
     * Get the configuration details for the specified class.
     *
     * @param name the fully qualified class name or config file
     * @param detailed true for verbose mode, false otherwise
     * @return the config response object
     */
    public Response getConfigs(String name, boolean detailed) {
        try {
<span class="nc" id="L57">            return Response.ok().entity(getConfigsResponse(name, detailed)).build();</span>
<span class="nc" id="L58">        } catch (IOException e) {</span>
<span class="nc" id="L59">            ConfigsResponseEntity cre = new ConfigsResponseEntity();</span>
<span class="nc" id="L60">            cre.addError(e.getMessage());</span>
<span class="nc" id="L61">            return Response.serverError().entity(cre).build();</span>
        }
    }

    /**
     * Get the configuration details for the specified class.
     *
     * @param name the fully qualified class name or config file
     * @param detailed true for verbose mode, false otherwise
     * @return the config response object
     */
    public static ConfigsResponseEntity getConfigsResponse(String name, boolean detailed) throws IOException {
<span class="nc" id="L73">        final String cfg = validate(name);</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        return detailed ? getEmissaryConfigDetailed(cfg) : getEmissaryConfig(cfg);</span>
    }

    /**
     * Get the key/value pairs for a configuration file. Returns one output for all combined flavored configs.
     *
     * @param cfg the config file
     * @return the config response object
     */
    public static ConfigsResponseEntity getEmissaryConfig(final String cfg) throws IOException {
<span class="nc" id="L84">        ConfigList list = new ConfigList();</span>
<span class="nc" id="L85">        list.addConfig(new Config(ConfigUtil.getFlavors(), combineConfigs(cfg, ConfigUtil.addFlavors(cfg)),</span>
<span class="nc" id="L86">                normalizeEntries(ConfigUtil.getConfigInfo(cfg))));</span>
<span class="nc" id="L87">        return new ConfigsResponseEntity(list);</span>
    }

    /**
     * Get detailed output for a configuration file. Returns flavored config files one at a time and then the combined
     * output for all flavors.
     *
     * @param cfg the config file
     * @return the config response object
     */
    public static ConfigsResponseEntity getEmissaryConfigDetailed(final String cfg) throws IOException {
<span class="nc" id="L98">        ConfigList detailed = new ConfigList();</span>
<span class="nc" id="L99">        List&lt;String&gt; flavors = ConfigUtil.getFlavors();</span>

        // default config
<span class="nc" id="L102">        detailed.addConfig(new Config(Collections.emptyList(), Collections.singletonList(cfg),</span>
<span class="nc" id="L103">                normalizeEntries(new ServiceConfigGuide(ConfigUtil.getConfigStream(cfg), cfg))));</span>

        // flavored configs
<span class="nc" id="L106">        String[] flavoredCfgs = ConfigUtil.addFlavors(cfg);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">        for (final String flavoredName : flavoredCfgs) {</span>
<span class="nc" id="L108">            String flavor = StringUtils.substringBeforeLast(StringUtils.substringAfterLast(flavoredName, &quot;-&quot;), &quot;.&quot;);</span>
<span class="nc" id="L109">            addDetail(detailed, Collections.singletonList(flavor), Collections.singletonList(flavoredName), flavoredName);</span>
        }

        // all together now - same output as getEmissaryConfig
<span class="nc" id="L113">        addDetail(detailed, flavors, combineConfigs(cfg, flavoredCfgs), cfg);</span>

<span class="nc" id="L115">        return new ConfigsResponseEntity(detailed);</span>
    }

    /**
     * Validate the provided class name
     *
     * @param config the full qualified class name or config file
     * @return the default configuration file for the class
     */
    protected static String validate(String config) {
<span class="nc bnc" id="L125" title="All 10 branches missed.">        if (StringUtils.isBlank(config) || config.contains(&quot;\\&quot;) || config.contains(&quot;/&quot;) || config.contains(&quot;..&quot;) || config.endsWith(&quot;.&quot;)) {</span>
<span class="nc" id="L126">            throw new IllegalArgumentException(&quot;Invalid config name: &quot; + config);</span>
        }
<span class="nc" id="L128">        return StringUtils.appendIfMissing(StringUtils.trim(config), CONFIG_FILE_ENDING);</span>
    }

    /**
     * Combine all configs into a single list
     *
     * @param cfg the default config
     * @param flavoredConfigs the flavored configs
     * @return a combined list of flavored configs
     */
    protected static List&lt;String&gt; combineConfigs(final String cfg, String[] flavoredConfigs) {
<span class="nc" id="L139">        List&lt;String&gt; configs = Lists.newArrayList(cfg);</span>
<span class="nc" id="L140">        configs.addAll(Arrays.asList(flavoredConfigs));</span>
<span class="nc" id="L141">        return configs;</span>
    }

    /**
     * Normalize the output generated from the merge of key/value pairs (sort, distinct, etc.)
     *
     * @param cfg the configured properties
     * @return a sorted, distinct list of properties
     */
    protected static List&lt;ConfigEntry&gt; normalizeEntries(Configurator cfg) {
<span class="nc" id="L151">        return cfg.getEntries().stream()</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">                .sorted(Comparator.comparingInt((ConfigEntry ce) -&gt; RESERVED_SERVICE_CONFIG_KEYS.contains(ce.getKey()) ? 0 : 1)</span>
<span class="nc" id="L153">                        .thenComparing(ConfigEntry::getKey)</span>
<span class="nc" id="L154">                        .thenComparing(ConfigEntry::getValue))</span>
<span class="nc" id="L155">                .distinct()</span>
<span class="nc" id="L156">                .collect(Collectors.toList());</span>
    }

    /**
     * Add the configuration properties to the response object
     *
     * @param detailed the config list
     * @param flavors the flavors used to generate properties
     * @param configs the list of configs used to generate properties
     * @param cfgFile the config file
     */
    protected static void addDetail(ConfigList detailed, List&lt;String&gt; flavors, List&lt;String&gt; configs, String cfgFile) {
        try {
<span class="nc" id="L169">            detailed.addConfig(new Config(flavors, configs, normalizeEntries(ConfigUtil.getConfigInfo(cfgFile))));</span>
<span class="nc" id="L170">        } catch (IOException e) {</span>
<span class="nc" id="L171">            detailed.addConfig(new Config(flavors, configs, Collections.emptyList()));</span>
<span class="nc" id="L172">        }</span>
<span class="nc" id="L173">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>